<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expansive Tracker</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body data-theme="dark">
  <div class="app container-fluid p-3">
    <aside class="sidebar card-glass" id="sidebar">
      <div class="brand d-flex align-items-center gap-3 mb-4">
        <div class="logo shadow-glow">ET</div>
        <div>
          <div class="h6 mb-0 fw-bold text-light">Expansive Tracker</div>
          <div class="small-muted">Premium Finance Dashboard</div>
        </div>
      </div>

      <nav class="d-flex flex-column gap-1" id="nav">
        <a href="{{ url_for('index') }}" class="nav-item" data-target="dashboard">
          <i class="bi bi-speedometer2"></i> Dashboard
        </a>
        <a href="{{ url_for('add_page') }}" class="nav-item" data-target="add">
          <i class="bi bi-plus-square"></i> Add Transaction
        </a>
        <a href="{{ url_for('analytics_page') }}" class="nav-item" data-target="analytics">
          <i class="bi bi-pie-chart"></i> Analytics
        </a>
        <a href="{{ url_for('history_page') }}" class="nav-item" data-target="history">
          <i class="bi bi-clock-history"></i> History
        </a>
      </nav>

      <div class="mt-4 d-flex align-items-center justify-content-between">
        <div class="small-muted">Theme</div>
        <div>
          <button id="themeToggle" class="btn btn-sm btn-outline-light rounded-5 px-3" title="Toggle dark/light">
            <i id="themeIcon" class="bi bi-moon-stars-fill"></i>
          </button>
        </div>
      </div>

      <div class="mt-3 small-muted text-center">Local-first • Secure storage</div>
    </aside>

    <main class="main">
      <div class="topbar d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
          <button id="sidebarToggle" class="btn btn-sm btn-outline-light d-lg-none"><i class="bi bi-list"></i></button>
          <div>
            <h4 class="mb-0 text-accent fw-bold" id="pageTitle">{% if active_section == 'dashboard' %}Dashboard{% elif active_section=='add' %}Add Transaction{% elif active_section=='analytics' %}Analytics{% else %}History{% endif %}</h4>
            <div class="small-muted" id="pageSubtitle">
              {% if active_section=='dashboard' %}Overview & quick insights{% elif active_section=='add' %}Record income or expense{% elif active_section=='analytics' %}Detailed spending breakdown{% else %}All entries from database{% endif %}
            </div>
          </div>
        </div>

        <div class="d-flex align-items-center">
          <div class="muted-pill glow-border">Balance:
            <strong id="topTotal">₹ {{ '%.2f' % summary['balance'] }}</strong>
          </div>

          <!-- LOGOUT BUTTON -->
          <a href="{{ url_for('logout') }}" 
             class="btn btn-sm btn-outline-light rounded-circle ms-3"
             title="Logout">
           <i id="logoutIcon" class="bi bi-box-arrow-right"></i>

          </a>
        </div>
      </div>

      <div class="content-sections">

        <!-- Dashboard -->
        <section class="page-section {% if active_section=='dashboard' %}active{% endif %}" data-name="dashboard">
          <div class="balance-row mb-3">
            <div class="card-glass balance-card text-center">
              <div class="small-muted">Total Income</div>
              <div class="balance-value text-success">₹ <span id="totalIncome">0</span></div>
              <div class="small-muted">Category: Income</div>
            </div>

            <div class="card-glass balance-card text-center">
              <div class="small-muted">Total Expense</div>
              <div class="balance-value text-danger">₹ <span id="totalExpense">0</span></div>
              <div class="small-muted">All expenses</div>
            </div>

            <div class="card-glass balance-card text-center">
              <div class="small-muted">Remaining Balance</div>
              <div class="balance-value text-accent">₹ <span id="remainingBalance">0</span></div>
              <div class="small-muted">Income − Expense</div>
            </div>
          </div>

          <div class="d-grid-2-col gap-3">
            <!-- Recent Transactions + Chart -->
            <div>
              <div class="card-glass p-3 mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <div class="small-muted">Spending by Category</div>
                    <div class="h6 mb-0 text-accent">Analytics (Live)</div>
                  </div>
                </div>

                <div class="row g-3">
                  <div class="col-12 col-md-5">
                    <div class="chart-wrap"><canvas id="spendChart"></canvas></div>
                  </div>
                  <div class="col-12 col-md-7">
                    <div class="transactions-card" style="max-height:260px;overflow:auto">
                      <table class="table table-borderless table-sm mb-0">
                        <thead>
                          <tr><th>Txn</th><th>Category</th><th class="text-end">Amount</th><th></th></tr>
                        </thead>
                        <tbody id="recentList">
                          {% for expense in expenses[:10] %}
                            <tr data-id="{{ expense[0] }}" data-category="{{ expense[3] }}">
                              <td title="{{ expense[4] }}">{{ expense[1] }}</td>
                              <td><span class="muted-pill">{{ expense[3] }}</span></td>
                              <td class="text-end">₹ {{ '%.2f' % expense[2] }}</td>
                              <td class="text-end">
                                <button class="btn btn-sm btn-link text-danger p-0 js-delete" data-id="{{ expense[0] }}" title="Delete">
                                  <i class="bi bi-trash"></i>
                                </button>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Add + Stats -->
            <div>
              <div class="card-glass p-3 mb-3">
                <div class="mb-2">
                  <div class="small-muted">Quick Add</div>
                  <div class="h6 mb-0 text-accent">Add Transaction</div>
                </div>

                <form id="quickAddForm" action="/api/add" method="POST" class="row g-2" autocomplete="off">
                  <div class="col-12">
                    <input id="qa_title" name="title" class="form-control form-control-sm" placeholder="e.g., Groceries / Salary" required>
                  </div>
                  <div class="col-12">
                    <select id="qa_category" name="category" class="form-select form-select-sm">
                      <option value="General">General</option>
                      <option value="Income">Income</option>
                      <option value="Food">Food</option>
                      <option value="Bills">Bills</option>
                      <option value="Transport">Transport</option>
                      <option value="Entertainment">Entertainment</option>
                      <option value="Health">Health</option>
                    </select>
                  </div>
                  <div class="col-8">
                    <input id="qa_amount" name="amount" type="number" step="0.01" class="form-control form-control-sm" placeholder="Amount (₹)" required>
                  </div>
                  <div class="col-4 d-grid">
                    <button class="glow-btn" type="submit"><i class="bi bi-plus-circle"></i> Add</button>
                  </div>
                </form>
              </div>

              <!-- Stats Card Restored -->
              <div class="card-glass p-3 text-center">
                <div class="small-muted mb-2">Stats</div>
                <div class="d-flex justify-content-around">
                  <div>
                    <div class="h5 mb-0" id="countTxns">0</div>
                    <div class="small-muted">Transactions</div>
                  </div>
                  <div>
                    <div class="h5 mb-0" id="avgSpend">₹0</div>
                    <div class="small-muted">Avg Expense</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Add Page -->
        <section class="page-section {% if active_section=='add' %}active{% endif %}" data-name="add">
          <div class="row justify-content-center">
            <div class="col-md-8">
              <div class="card-glass p-4">
                <h4 class="mb-3">New Transaction Entry</h4>
                <form id="addPageForm" action="{{ url_for('add_expense') }}" method="POST" class="row g-3">
                  <div class="col-12">
                    <label class="form-label small-muted">Title / Description</label>
                    <input name="title" class="form-control" placeholder="e.g., Dinner with friends" required>
                  </div>
                  <div class="col-12">
                    <label class="form-label small-muted">Category</label>
                    <select name="category" class="form-select">
                      <option value="General">General</option>
                      <option value="Income">Income</option>
                      <option value="Food">Food</option>
                      <option value="Bills">Bills</option>
                      <option value="Transport">Transport</option>
                      <option value="Entertainment">Entertainment</option>
                      <option value="Health">Health</option>
                      <option value="Savings">Savings/Investment</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label class="form-label small-muted">Amount (₹)</label>
                    <input name="amount" type="number" step="0.01" class="form-control" placeholder="0.00" required>
                  </div>
                  <div class="col-12 d-grid mt-2">
                    <button class="glow-btn" type="submit"><i class="bi bi-plus-circle"></i> Record Transaction</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </section>

        <!-- Analytics -->
        <section class="page-section {% if active_section=='analytics' %}active{% endif %}" data-name="analytics">
          <div class="card-glass p-4">
            <h5 class="mb-3 text-accent">Spending Breakdown</h5>
            <div class="analytics-row d-flex flex-wrap gap-3">
              <div class="analytics-chart flex-grow-1">
                <div class="chart-wrap" style="height:350px;">
                  <canvas id="fullAnalyticsChart"></canvas>
                </div>
              </div>
              <div class="analytics-categories flex-shrink-1" style="min-width:220px;">
                <h6 class="small-muted mt-3 mt-md-0">Category Totals</h6>
                <div id="categorySummaryList"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- History -->
        <section class="page-section {% if active_section=='history' %}active{% endif %}" data-name="history">
          <div class="card-glass p-3">
            <div style="overflow:auto;">
              <table class="table table-borderless table-sm mb-0">
                <thead>
                  <tr><th>Title</th><th>Category</th><th class="text-end">Amount</th><th class="text-end">When</th><th></th></tr>
                </thead>
                <tbody id="historyTable">
                  {% if expenses %}
                    {% for expense in expenses %}
                      <tr data-id="{{ expense[0] }}">
                        <td>{{ expense[1] }}</td>
                        <td><span class="muted-pill">{{ expense[3] }}</span></td>
                        <td class="text-end">₹ {{ '%.2f' % expense[2] }}</td>
                        <td class="text-end" style="white-space:nowrap">{{ expense[4] }}</td>
                        <td class="text-end">
                          <button class="btn btn-sm btn-link text-danger p-0 js-delete" data-id="{{ expense[0] }}"><i class="bi bi-trash"></i></button>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="5" class="text-center text-muted">No transactions yet.</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </section>

      </div>

      <footer class="small-muted mt-3 text-center">
        Made with ❤️ • Expensive Tracker — local + server powered
      </footer>
    </main>
  </div>

<script>
  window.EXP_SUMMARY = {
    total_income: {{ summary['total_income'] | default(0) | float }},
    total_expense: {{ summary['total_expense'] | default(0) | float }},
    balance: {{ summary['balance'] | default(0) | float }},
    by_category: {{ summary["by_category"] | tojson | safe }}
  };
  window.EXP_ITEMS = {{ expenses | tojson | safe }};
</script>

<script src="{{ url_for('static', filename='style.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
